<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TL Equipment Inventory</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    html {
      height: 100vh;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #001538; /* TL Dark Blue */
      color: #EEEEEE; /* TL Off-White */
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-sizing: border-box;
    }
    #app {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Magic fix for flex children with overflow */
    }
    .page-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      flex-shrink: 0;
    }
    .logo-container {
      flex: 1;
    }
    .logo-container img {
      height: 40px;
    }
    .page-title {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      color: #EEEEEE;
      margin: 0;
    }
    .controls-container {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 12px;
    }
    .filter-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #table-info {
      font-weight: 500;
      text-align: center;
      margin-bottom: 20px;
    }
    .button-container {
      flex: 1;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    button {
      background-color: #4b5563; /* A mid-gray */
      color: #f9fafb; /* Off-white */
      border: 1px solid #6b7280;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #6b7280;
    }
    button#signin {
      background-color: #3BB0D4; /* TL Cyan */
      border-color: #3BB0D4;
    }
    button#signin:hover {
      background-color: #349dbb; /* Darker TL Cyan */
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.unsaved {
      background-color: #F7C95E; /* TL Yellow */
      border-color: #F7C95E;
    }
    button.unsaved:hover:not(:disabled) {
      background-color: #F09F26; /* TL Orange */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #374151; /* Dark gray for table bg */
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .table-wrapper {
      flex-grow: 1;
      overflow-y: auto;
      border-radius: 8px;
    }
    td, th { border: 1px solid #4b5563; padding: 4px 6px; } /* Mid-gray border */
    thead th {
      background-color: #111827; /* Very dark gray for header */
      color: #e5e7eb; /* Light gray text for header */
      font-weight: 600;
      text-align: left;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }
    thead th[data-sortable="true"] {
      cursor: pointer;
    }
    input[type="text"], td select, .add-item-form select {
      width: 100%;
      background-color: #374151; /* Dark gray */
      border: 1px solid #4b5563; /* Mid-gray border */
      color: #f9fafb;
      padding: 6px 8px;
      border-radius: 4px;
      box-sizing: border-box; /* Important for consistent sizing */
    }
    td input[type="text"], td select {
      background-color: #4b5563; /* Original gray */
      border-color: #6b7280; /* Original gray border */
    }
    .add-item-form select {
      min-width: 150px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #3BB0D4;
      box-shadow: 0 0 0 2px #3BB0D4;
    }
    .filter-container select {
      background-color: #374151; /* Dark gray */
      border: 1px solid #4b5563; /* Mid-gray border */
      color: #f9fafb;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.875rem;
    }
    #searchInput {
      max-width: 500px;
      padding: 10px 15px;
      font-size: 1rem;
      background-color: #374151; /* Dark gray */
      border: 1px solid #4b5563; /* Mid-gray border */
      color: #f9fafb;
      border-radius: 6px;
      width: 400px;
    }
    #searchInput:focus {
      outline: none;
      border-color: #3BB0D4;
      box-shadow: 0 0 0 2px #3BB0D4;
    }
    #searchInput::placeholder { color: #a0a0a0; }
    #sheet tr th:first-child,
    #sheet tr td:first-child {
      width: 250px;
    }
    #add-item-container {
      background-color: #001538; /* TL Dark Blue */
      border: 1px solid #3BB0D4; /* TL Cyan */
      box-shadow: 0 0 15px rgba(59, 176, 212, 0.2); /* Cyan glow */
      padding: 24px;
      border-radius: 12px;
      margin: 0 auto 24px auto; /* Center with indentation */
      max-width: 95%;
    }
    .add-item-form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px 15px; /* row-gap column-gap */
      align-items: flex-end;
      justify-content: center;
    }
    .add-item-form .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .add-item-form label {
      font-size: 0.75rem;
      color: #a0a0a0;
      text-transform: uppercase;
      font-weight: 600;
    }
    .add-item-form button {
      background-color: #3BB0D4;
      border-color: #3BB0D4;
    }
    .add-item-form button:hover:not(:disabled) {
      background-color: #349dbb;
    }
    .add-item-form button:disabled {
      opacity: 0.7;
    }
    .add-item-form .wide-add-input {
      width: 250px;
    }
    .sheet-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .sheet-selector button {
      background-color: #374151; /* Dark gray */
      border: 1px solid #4b5563; /* Mid-gray border */
    }
    .sheet-selector button.active {
      background-color: #3BB0D4; /* TL Cyan */
      border-color: #3BB0D4;
      font-weight: 700;
    }
    .serial-column {
      width: 90px;
    }
    th.count-column,
    td.count-column {
      width: 50px;
      text-align: center;
    }
    .action-column {
      width: 1%;
      white-space: nowrap;
      text-align: center;
    }
    .delete-btn {
      background-color: #ED5651; /* TL Red */
      border: none;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .delete-btn:hover {
      background-color: #d54c47; /* Darker TL Red */
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 21, 56, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #002052;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
    }
    .table-container {
      flex-grow: 1;
      position: relative; /* For absolute positioning of tables */
    }
    .modal-content h3 {
      margin-top: 0;
      color: #EEEEEE;
    }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .modal-buttons button.danger {
      background-color: #ED5651; /* TL Red */
      border-color: #ED5651;
    }
    /* Loading Spinner Styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 21, 56, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      color: #EEEEEE;
      font-size: 1.2rem;
    }
    .spinner {
      border: 5px solid #4b5563;
      border-top: 5px solid #3BB0D4;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <header class="page-header">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/liquid-coop/equipment-checkout/main/Horizontal-Mono-Light.png" alt="Company Logo"
           onerror="this.style.display='none'">
    </div>
    <h1 class="page-title">Equipment Inventory</h1>
    <div class="button-container">
      <button id="refresh-btn" onclick="loadData()">Refresh</button>
      <button id="save-data-btn" style="display:none" class="unsaved">Save Changes</button>
    </div>
  </header>

  <!-- Main app -->
  <div id="app">
    <div id="sheet-selector" class="sheet-selector"></div>
    <div id="add-item-container" style="display:none;"></div>
    <div class="controls-container">
      <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search by any column...">
      <div id="filter-container" class="filter-container"></div>
    </div>
    <div id="table-info"></div>
    <div id="table-container" class="table-container">
      <!-- Tables for each sheet will be injected here -->
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete this item? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button id="cancel-delete">Cancel</button>
        <button id="confirm-delete" class="danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p>Loading Data...</p>
  </div>

  <script>
    const CONSTANTS = {
      PREDEFINED_STATUSES: ['Good', 'Usable', 'Needs Repair', 'Out for Repair', 'Missing']
    };

    // Global state
    let dataState = {
      sha: null // The SHA of the file from GitHub, needed for updates
    };
    let allData = {}; // Will hold data for all sheets, e.g., { LA: [...], BR: [...] }
    let currentSheetName = localStorage.getItem('currentSheetName') || 'LA';
    let availableSheets = [];

    let totalItemCount = 0;
    let rowToDelete = null;
    let sortState = {
      columnIndex: null,
      direction: 'asc' // 'asc' or 'desc'
    };
    let originalHeaders = [];

    // ---- INITIALIZATION ----
    document.addEventListener('DOMContentLoaded', () => {
      loadData(); // Load data from GitHub on page load
      document.getElementById('save-data-btn').addEventListener('click', commitChangesToGitHub);

      document.getElementById('cancel-delete').onclick = () => {
        document.getElementById('delete-modal').style.display = 'none';
        rowToDelete = null;
      };

      document.getElementById('confirm-delete').addEventListener('click', () => {
        if (rowToDelete !== null) deleteRow(rowToDelete);
      });
    });

    function processCsvData(csvString, silent = false) {
      Papa.parse(csvString, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
              if (!results.data.length || !results.meta.fields.includes('location')) {
                  alert('Invalid CSV format from GitHub. Make sure the file is a valid CSV and contains a "location" column.');
                  return;
              }

              const newData = {};
              const headersWithoutLocation = results.meta.fields.filter(h => h !== 'location');

              results.data.forEach(row => {
                  const location = row.location;
                  if (!location) return;

                  if (!newData[location]) {
                      newData[location] = [headersWithoutLocation];
                  }
                  
                  const rowData = headersWithoutLocation.map(header => row[header] || '');
                  newData[location].push(rowData);
              });

              allData = newData;
              availableSheets = Object.keys(allData).sort();
              if (!availableSheets.includes(currentSheetName)) {
                  currentSheetName = availableSheets[0] || 'LA';
              }

              document.getElementById('add-item-container').style.display = 'block';

              createSheetSelector();
              renderAllSheets(silent);
          },
          error: (error) => {
              alert('Error parsing CSV file from GitHub.');
              console.error("CSV Parse Error:", error);
          }
      });
    }

    async function loadData(silent = false) {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (!silent) loadingOverlay.style.display = 'flex';
      try {
        const res = await fetch('/api/inventory'); // Call our new backend

        if (!res.ok) {
            if (res.status === 404) {
                alert('database.csv not found in the repository. Please create it.');
                allData = {}; // Start with empty data
                dataState.sha = null;
            } else {
                throw new Error(`API Error: ${(await res.json()).message}`);
            }
        } else {
            const data = await res.json();
            dataState.sha = data.sha;
            const csvContent = atob(data.content); // Decode from base64
            processCsvData(csvContent, silent);
        }
      } catch (err) {
        alert(`Failed to load data: ${err.message}`);
        console.error(err);
      } finally {
        if (!silent) loadingOverlay.style.display = 'none';
      }
    }

    function prepareDataForSave() {
        const flatData = [];
        for (const location in allData) {
            const headers = allData[location][0];
            const rows = allData[location].slice(1);
            rows.forEach(row => {
                const rowObject = { location };
                headers.forEach((header, index) => rowObject[header] = row[index]);
                flatData.push(rowObject);
            });
        }
        return Papa.unparse(flatData);
    }

    async function commitChangesToGitHub(arg) {
      const throwOnError = arg === true;
      const saveBtn = document.getElementById('save-data-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const newCsvContent = prepareDataForSave();
        const encodedContent = btoa(newCsvContent); // Base64 encode

        const res = await fetch('/api/inventory', { // Call our new backend
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Update inventory via web app',
                content: encodedContent,
                sha: dataState.sha
            })
        });

        if (!res.ok) throw new Error(`API Error: ${(await res.json()).message}`);
        
        const data = await res.json();
        // The backend doesn't send the new sha on PUT, so we reload to get it.
        // This also confirms the save was successful.
        await loadData(true); // Reload data silently to get the new SHA
      } catch (err) {
        console.error(err);
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
        
        if (throwOnError) {
            throw err;
        } else {
            alert(`Failed to save changes to GitHub: ${err.message}`);
        }
      }
    }
    function getHeaderDisplayText(originalHeader) {
        const headerMap = {
            'Quantity': '#',
            'Serial number': 'Serial #'
        };
        return headerMap[originalHeader] || originalHeader;
    }

    // ---- FETCH DATA ----
    function renderSheet(sheetName, container) {
      const values = allData[sheetName] || [];
      
      // If there are headers, create the add item form (only for the first active sheet)
        if (values.length > 0) {
          originalHeaders = values[0];
          createAddItemForm(values);
        }

        // Create the filter dropdowns before rendering the table
        createFilterDropdowns(values);
        
        const table = document.createElement('table');
        table.id = `sheet-${sheetName}`;
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';
        tableWrapper.style.position = 'absolute';
        tableWrapper.style.top = '0';
        tableWrapper.style.left = '0';
        tableWrapper.style.right = '0';
        tableWrapper.style.bottom = '0';
        tableWrapper.appendChild(table);

        // Find category column index and unique values for dropdowns
        const headers = values[0];
        
        // Use categories from 'LA' tab
        let uniqueCategories = [];
        const categorySource = allData['LA'] || values;
        if (categorySource && categorySource.length > 0) {
            const sourceHeaders = categorySource[0];
            const sourceRows = categorySource.slice(1);
            const sourceCatIndex = sourceHeaders.findIndex(h => h.toLowerCase() === 'category');
            if (sourceCatIndex !== -1) {
                uniqueCategories = [...new Set(sourceRows.map(row => row[sourceCatIndex]).filter(Boolean))].sort();
            }
        }

        // If there's only a header or no data, just append the empty wrapper and stop.
        if (values.length <= 1) {
            container.appendChild(tableWrapper);
            return;
        }


        // Create thead and tbody
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        table.appendChild(thead);
        table.appendChild(tbody);

        // Header Row (first row of data)
        const headerRow = document.createElement('tr');
        originalHeaders.forEach((headerText, index) => {
          if (headerText.toLowerCase() === 'owner' || headerText.toLowerCase() === 'quantity') return;
          const th = document.createElement('th');
          th.textContent = getHeaderDisplayText(headerText);
          th.dataset.sortable = "true";
          th.dataset.columnIndex = index;
          th.onclick = () => sortTable(index);

          const lowerCaseHeader = headerText.toLowerCase();
          switch (lowerCaseHeader) {
            case 'quantity':
              th.classList.add('count-column');
              break;
            case 'serial number':
              th.classList.add('serial-column');
              break;
          }
          headerRow.appendChild(th);
        });
        const actionTh = document.createElement('th');
        actionTh.textContent = '';
        actionTh.classList.add('action-column');
        headerRow.appendChild(actionTh);
        thead.appendChild(headerRow);

        // Data Rows (rest of the data)
        values.slice(1).forEach((row, index) => {
          const tr = document.createElement('tr');
          // Iterate over headers to ensure a cell is created for every column, even if empty.
          originalHeaders.forEach((header, headerIndex) => {
            if (header.toLowerCase() === 'owner' || header.toLowerCase() === 'quantity') return;
            const cellValue = row[headerIndex] || ''; // Use empty string for missing cells
            const td = document.createElement('td');

            const lowerCaseHeader = header.toLowerCase();
            switch (lowerCaseHeader) {
              case 'quantity':
                td.classList.add('count-column');
                break;
              case 'serial number':
                td.classList.add('serial-column');
                break;
            }

            if (header.toLowerCase() === 'category') {
              const select = document.createElement('select');
              select.onchange = (e) => updateCell(index + 1, headerIndex, e.target.value);

              // Create a combined list of options to avoid duplicates and ensure the current value is present
              const options = [...uniqueCategories];
              if (cellValue && !options.includes(cellValue)) {
                  options.push(cellValue);
                  options.sort();
              }

              options.forEach(cat => {
                  const option = document.createElement('option');
                  option.value = cat;
                  option.textContent = cat;
                  select.appendChild(option);
              });

              select.value = cellValue;
              td.appendChild(select);
            } else if (header.toLowerCase() === 'status') {
              const select = document.createElement('select');
              select.onchange = (e) => updateCell(index + 1, headerIndex, e.target.value);
              CONSTANTS.PREDEFINED_STATUSES.forEach(stat => {
                const option = document.createElement('option');
                option.value = stat;
                option.textContent = stat;
                select.appendChild(option);
              });
              select.value = cellValue;
              td.appendChild(select);
            } else {
              const input = document.createElement('input');
              input.type = 'text';
              input.value = cellValue;
              input.onchange = (e) => updateCell(index + 1, headerIndex, e.target.value);
              td.appendChild(input);
            }
            tr.appendChild(td);
          });

          // Add delete button cell
          const actionTd = document.createElement('td');
          actionTd.classList.add('action-column');
          const deleteButton = document.createElement('button');
          deleteButton.textContent = 'X';
          deleteButton.className = 'delete-btn';
          // The data row index is `index + 1` (since we sliced the header)
          deleteButton.onclick = () => promptDelete(index + 1);
          actionTd.appendChild(deleteButton);
          tr.appendChild(actionTd);

          tbody.appendChild(tr);
        });

        container.appendChild(tableWrapper);
    }

    function renderAllSheets(silent = false) {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (!silent) loadingOverlay.style.display = 'flex';
      
      const tableContainer = document.getElementById('table-container');
      tableContainer.innerHTML = ''; // Clear all old tables

      try {
        availableSheets.forEach(sheetName => {
            renderSheet(sheetName, tableContainer);
        });
        
        // After rendering, switch to the correct initial view
        switchSheet(currentSheetName, true);

      } catch (err) {
        console.error("Failed to render data:", err);
        alert("An error occurred while loading the data. Please check the console for more details and try refreshing the page.");
      } finally {
        if (!silent) loadingOverlay.style.display = 'none';
      }
    }

    function renderCurrentSheet() {
        // This function is now a lightweight wrapper to re-render just the current sheet after edits.
        const tableContainer = document.getElementById('table-container');
        document.getElementById(`sheet-${currentSheetName}`)?.parentElement.remove();
        renderSheet(currentSheetName, tableContainer);
        updateSortIndicators(); // Apply indicators if table was previously sorted
    }

    // ---- UPDATE CELL ----
    function updateCell(rowIndex, colIndex, value) {
      // rowIndex is 1-based for data rows (header is row 0)
      if (allData[currentSheetName] && allData[currentSheetName][rowIndex]) {
        allData[currentSheetName][rowIndex][colIndex] = value;
      }
      const saveBtn = document.getElementById('save-data-btn');
      saveBtn.style.display = 'inline';
      // No need to re-render, the input field holds the state.
      // We could add a "dirty" flag to the save button here if desired.
    }

    // ---- ADD ITEM ----
    async function addItem() {
      const addButton = document.querySelector('.add-item-form button');
      const fields = document.querySelectorAll('.add-item-form input[type="text"], .add-item-form select');
      const newRow = Array.from(fields).map(field => field.value);

      if (newRow.every(cell => cell.trim() === '')) {
        alert('Please fill in at least one field to add an item.');
        return;
      }

      addButton.disabled = true;
      addButton.textContent = 'Saving...';

      allData[currentSheetName].push(newRow);
      renderCurrentSheet(); // Refresh the entire view
      
      try {
          await commitChangesToGitHub(true);
      } catch (err) {
          // If we get a SHA mismatch, it means someone else updated the file.
          // We should reload the data, re-apply our new item, and try again.
          if (err.message && err.message.includes('does not match')) {
              console.log('SHA mismatch detected. Reloading and retrying...');
              allData[currentSheetName].pop(); // Remove the item we just added to the stale data
              await loadData(true); // Fetch latest data
              allData[currentSheetName].push(newRow); // Add item to fresh data
              renderCurrentSheet();
              await commitChangesToGitHub(); // Retry save (standard alert on fail)
          } else {
              alert(`Failed to save changes to GitHub: ${err.message}`);
          }
      }

      addButton.disabled = false;
      addButton.textContent = 'Add Item';
    }

    function createAddItemForm(values) {
      const container = document.getElementById('add-item-container');
      container.innerHTML = ''; // Clear previous form

      if (values.length === 0) return;
      const headers = values[0];
      const dataRows = values.slice(1);

      // Use categories from 'LA' tab
      let uniqueCategories = [];
      const categorySource = allData['LA'] || values;
      if (categorySource && categorySource.length > 0) {
          const sourceHeaders = categorySource[0];
          const sourceRows = categorySource.slice(1);
          const sourceCatIndex = sourceHeaders.findIndex(h => h.toLowerCase() === 'category');
          if (sourceCatIndex !== -1) {
              uniqueCategories = [...new Set(sourceRows.map(row => row[sourceCatIndex]).filter(Boolean))].sort();
          }
      }

      const brandIndex = headers.findIndex(h => h.toLowerCase() === 'brand');
      let uniqueBrands = [];
      if (brandIndex !== -1) {
        uniqueBrands = [...new Set(dataRows.map(row => row[brandIndex]).filter(Boolean))].sort();
      }

      const form = document.createElement('div');
      form.className = 'add-item-form';

      headers.forEach(header => {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        if (header.toLowerCase() === 'owner' || header.toLowerCase() === 'quantity') {
          inputGroup.style.display = 'none';
        }

        const label = document.createElement('label');
        label.textContent = header;
        inputGroup.appendChild(label);

        if (header.toLowerCase() === 'category') {
          const select = document.createElement('select');
          
          const placeholder = document.createElement('option');
          placeholder.value = "";
          placeholder.textContent = "Choose Category";
          placeholder.disabled = true;
          placeholder.selected = true;
          select.appendChild(placeholder);

          uniqueCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
          inputGroup.appendChild(select);
        } else if (header.toLowerCase() === 'status') {
          const select = document.createElement('select');

          CONSTANTS.PREDEFINED_STATUSES.forEach(stat => {
            const option = document.createElement('option');
            option.value = stat;
            option.textContent = stat;
            if (stat === 'Good') {
              option.selected = true; // Set 'Good' as the default
            }
            select.appendChild(option);
          });
          inputGroup.appendChild(select);
        } else if (header.toLowerCase() === 'brand') {
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'Enter or select brand...';
          input.setAttribute('list', 'brand-datalist');

          const dataList = document.createElement('datalist');
          dataList.id = 'brand-datalist';

          uniqueBrands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            dataList.appendChild(option);
          });

          inputGroup.appendChild(input);
          inputGroup.appendChild(dataList);
        } else {
          const input = document.createElement('input');
          input.type = 'text';

          const lowerCaseHeader = header.toLowerCase();
          if (lowerCaseHeader === 'quantity') {
            input.value = '1';
          } else {
            input.placeholder = `Enter ${header}...`;
          }

          if (['item', 'description', 'notes'].includes(lowerCaseHeader)) {
            input.classList.add('wide-add-input');
          }

          inputGroup.appendChild(input);
        }
        form.appendChild(inputGroup);
      });

      const addButton = document.createElement('button');
      addButton.textContent = 'Add Item';
      addButton.onclick = addItem;
      addButton.style.padding = '10px 24px';
      addButton.style.fontSize = '1rem';
      form.appendChild(addButton);

      container.appendChild(form);
    }

    // ---- DELETE ITEM ----
    function promptDelete(rowIndex) {
      rowToDelete = rowIndex;
      document.getElementById('delete-modal').style.display = 'flex';
    }
    
    async function deleteRow(rowIndex) {
      document.getElementById('delete-modal').style.display = 'none';

      // rowIndex is 1-based for data rows. The array is 0-based.
      // allData[currentSheetName] includes the header row, so the index matches.
      allData[currentSheetName].splice(rowIndex, 1);

      renderCurrentSheet(); // Refresh the view
      
      await commitChangesToGitHub();

      rowToDelete = null;
    }

    // ---- SHEET SWITCHING ----
    function createSheetSelector() {
      const container = document.getElementById('sheet-selector');
      container.innerHTML = ''; // Clear existing buttons

      availableSheets.forEach(sheetName => {
        const button = document.createElement('button');
        button.textContent = sheetName;
        button.dataset.sheet = sheetName;
        button.onclick = () => switchSheet(sheetName); 
        if (sheetName === currentSheetName) {
          button.classList.add('active');
        }
        container.appendChild(button);
      });
    }

    function switchSheet(sheetName, isInitialLoad = false) {
      currentSheetName = sheetName;
      localStorage.setItem('currentSheetName', sheetName);

      // Update the active state on the buttons
      document.querySelectorAll('#sheet-selector button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.sheet === sheetName);
      });
      
      // Hide all table wrappers
      document.querySelectorAll('#table-container .table-wrapper').forEach(wrapper => {
        wrapper.style.display = 'none';
      });

      // Show the correct one
      const activeWrapper = document.getElementById(`sheet-${sheetName}`)?.parentElement;
      if (activeWrapper) {
        activeWrapper.style.display = 'flex';
      }

      // Update item count display
      const values = allData[currentSheetName] || [];
      totalItemCount = values.length > 0 ? values.length - 1 : 0;
      document.getElementById('table-info').textContent = `${totalItemCount} item${totalItemCount !== 1 ? 's' : ''} in the equipment inventory.`;

      if (!isInitialLoad) applyFilters(); // Re-apply filters for the new view
    }

    // ---- SORTING ----
    function sortTable(columnIndex) {
      const table = document.getElementById(`sheet-${currentSheetName}`);
      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      // Determine sort direction
      let direction = 'asc';
      if (sortState.columnIndex === columnIndex && sortState.direction === 'asc') {
        direction = 'desc';
      }

      sortState.columnIndex = columnIndex;
      sortState.direction = direction;

      const rows = Array.from(tbody.rows);

      rows.sort((a, b) => {
        const aText = a.cells[columnIndex]?.querySelector('input')?.value || '';
        const bText = b.cells[columnIndex]?.querySelector('input')?.value || '';

        // Basic numeric check
        const aIsNum = !isNaN(parseFloat(aText)) && isFinite(aText);
        const bIsNum = !isNaN(parseFloat(bText)) && isFinite(bText);

        let comparison = 0;
        if (aIsNum && bIsNum) {
          comparison = parseFloat(aText) - parseFloat(bText);
        } else {
          comparison = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
        }

        return direction === 'asc' ? comparison : -comparison;
      });

      // Re-append sorted rows
      rows.forEach(row => tbody.appendChild(row));

      // Update header visuals
      updateSortIndicators();
    }

    function updateSortIndicators() {
      const table = document.getElementById(`sheet-${currentSheetName}`);
      const thead = table.querySelector('thead');
      if (!thead) return;

      const headers = thead.querySelectorAll('th[data-sortable="true"]');
      headers.forEach((th) => {
        const columnIndex = parseInt(th.dataset.columnIndex, 10);
        th.textContent = getHeaderDisplayText(originalHeaders[columnIndex]); // Reset to original text

        if (columnIndex === sortState.columnIndex) {
          const indicator = sortState.direction === 'asc' ? ' ▲' : ' ▼';
          th.textContent += indicator;
        }
      });
    }

    // ---- FILTERING LOGIC ----
    function createFilterDropdowns(values) {
      const container = document.getElementById('filter-container');
      container.innerHTML = ''; // Clear existing filters

      if (values.length < 2) return; // No data or only headers

      const headers = values[0];
      const dataRows = values.slice(1);

      const headersToExclude = ['item', 'quantity', 'serial number', 'description', 'owner'];

      headers.forEach((header, index) => {
        const lowerCaseHeader = header.toLowerCase();
        // Don't create filters for columns where a dropdown is not useful (e.g., unique values).
        if (headersToExclude.includes(lowerCaseHeader)) {
          return;
        }

        let uniqueValues;
        if (lowerCaseHeader === 'status') {
          uniqueValues = CONSTANTS.PREDEFINED_STATUSES;
        } else {
          // Get unique, non-empty values for the column and sort them
          uniqueValues = [...new Set(dataRows.map(row => row[index]).filter(Boolean))].sort();
        }

        // Don't create a filter if there are no unique options to choose from
        if (uniqueValues.length < 1) return;

        const select = document.createElement('select');
        select.dataset.columnIndex = index;
        select.onchange = applyFilters;

        // Add a default "All" option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = `All ${header}`;
        select.appendChild(defaultOption);

        // Add an option for each unique value
        uniqueValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });

        container.appendChild(select);
      });
    }

    function applyFilters() {
      const searchInput = document.getElementById('searchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const table = document.getElementById(`sheet-${currentSheetName}`);
      const tbody = table.querySelector('tbody');
      const tableInfo = document.getElementById('table-info');
      const filterSelects = document.querySelectorAll('#filter-container select');

      if (!tbody) return;

      const activeFilters = {};
      filterSelects.forEach(select => {
        if (select.value) {
          activeFilters[select.dataset.columnIndex] = select.value;
        }
      });

      const rows = tbody.getElementsByTagName('tr');
      let visibleRowCount = 0;

      for (const row of rows) {
        const cellControls = row.querySelectorAll('input[type="text"], select');
        let matchesFilters = true;
        for (const columnIndex in activeFilters) {
          if (cellControls[columnIndex]?.value !== activeFilters[columnIndex]) {
            matchesFilters = false;
            break;
          }
        }

        const rowText = Array.from(cellControls).map(i => i.value).join(' ').toLowerCase();
        const matchesSearch = !searchTerm || rowText.includes(searchTerm);

        const isVisible = matchesFilters && matchesSearch;
        row.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleRowCount++;
      }

      if (searchTerm || Object.keys(activeFilters).length > 0) {
        tableInfo.textContent = `Found ${visibleRowCount} matching item${visibleRowCount !== 1 ? 's' : ''}.`;
      } else {
        tableInfo.textContent = `${totalItemCount} item${totalItemCount !== 1 ? 's' : ''} in the equipment inventory.`;
      }
    }
  </script>
</body>
</html>
