<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Viewer/Editor</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #login { display: block; }
    #app { display: none; }
    table { border-collapse: collapse; margin-top: 10px; }
    td, th { border: 1px solid #ccc; padding: 4px; }
    input[type="password"] { width: 150px; }
    input[type="text"] { width: 100px; }
  </style>
</head>

<body>
  <!-- Password gate -->
  <div id="login">
    <h3>Password Required</h3>
    <input id="password" type="password" />
    <button onclick="login()">Login</button>
    <p id="loginStatus"></p>
  </div>

  <!-- Main app -->
  <div id="app">
    <button id="signin">Sign in</button>
    <button id="signout" style="display:none">Sign out</button>
    <button id="refresh" style="display:none" onclick="loadData()">Refresh</button>
    <table id="sheet"></table>
    <button id="save" style="display:none" onclick="saveData()">Save changes</button>
  </div>

  <script>
    // ---- CONFIG ----
    const CLIENT_ID = 'YOUR_OAUTH_CLIENT_ID';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const SPREADSHEET_ID = '1OoZGw6f5qtm--Srnxy41Db-yKrbprWL_PjGxW7PT1z4';
    const RANGE = 'Sheet1';
    const PASSWORD = 'admin';

    let tokenClient;
    let accessToken;

    // ---- PASSWORD LOGIN ----
    function login() {
      if (document.getElementById('password').value === PASSWORD) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'block';
      } else {
        document.getElementById('loginStatus').textContent = 'Wrong password';
      }
    }

    // ---- LOAD GAPI & INIT ----
    gapi.load('client', async () => {
      await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
    });

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          accessToken = resp.access_token;
          document.getElementById('signin').style.display = 'none';
          document.getElementById('signout').style.display = 'inline';
          document.getElementById('refresh').style.display = 'inline';
          document.getElementById('save').style.display = 'inline';
          loadData();
        },
      });

      document.getElementById('signin').onclick = () => tokenClient.requestAccessToken();
      document.getElementById('signout').onclick = () => {
        accessToken = null;
        google.accounts.oauth2.revoke(CLIENT_ID, () => {});
        document.getElementById('signin').style.display = 'inline';
        document.getElementById('signout').style.display = 'none';
        document.getElementById('refresh').style.display = 'none';
        document.getElementById('save').style.display = 'none';
        document.getElementById('sheet').innerHTML = '';
      };
    };

    // ---- FETCH DATA ----
    async function loadData() {
      if (!accessToken) return;
      gapi.client.setToken({ access_token: accessToken });

      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
      });
      const values = res.result.values || [];

      const table = document.getElementById('sheet');
      table.innerHTML = '';
      values.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = cell;
          td.appendChild(input);
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }

    // ---- SAVE DATA (Step 3) ----
    async function saveData() {
      const table = document.getElementById('sheet');
      const rows = Array.from(table.rows).map(tr =>
        Array.from(tr.cells).map(td => td.firstChild.value)
      );

      gapi.client.setToken({ access_token: accessToken });
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values: rows },
      });
      alert('Saved');
    }
  </script>
</body>
</html>
