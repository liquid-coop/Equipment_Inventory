<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Viewer/Editor</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    html {
      height: 100vh;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #1f2937; /* A dark blue-gray */
      color: #d1d5db; /* A light gray for text */
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-sizing: border-box;
    }
    #app {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Magic fix for flex children with overflow */
    }
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-shrink: 0;
    }
    .logo-container {
      flex: 1;
    }
    .logo-container img {
      height: 40px;
    }
    .page-title {
      flex: 2;
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      color: #f9fafb;
      margin: 0;
    }
    .header-spacer {
      flex: 1;
    }
    .search-container {
      text-align: center;
      margin-bottom: 12px;
    }
    .filter-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    #table-info {
      font-weight: 500;
      text-align: center;
      margin-bottom: 20px;
    }
    .button-container {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 12px;
    }
    button {
      background-color: #4b5563; /* A mid-gray */
      color: #f9fafb; /* Off-white */
      border: 1px solid #6b7280;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #6b7280;
    }
    button#signin {
      background-color: #4f46e5; /* A nice blue for primary action */
      border-color: #4f46e5;
    }
    button#signin:hover {
      background-color: #4338ca;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.unsaved {
      background-color: #f59e0b; /* amber-500 */
      border-color: #f59e0b;
    }
    button.unsaved:hover:not(:disabled) {
      background-color: #d97706; /* amber-600 */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #374151; /* Darker gray for table bg */
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .table-wrapper {
      flex-grow: 1;
      overflow-y: auto;
      border-radius: 8px;
    }
    td, th { border: 1px solid #4b5563; padding: 4px 6px; }
    thead th {
      background-color: #111827; /* Even darker for header */
      color: #e5e7eb;
      font-weight: 600;
      text-align: left;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }
    thead th[data-sortable="true"] {
      cursor: pointer;
    }
    input[type="text"], td select, .add-item-form select {
      width: 100%;
      background-color: #4b5563;
      border: 1px solid #6b7280;
      color: #f9fafb;
      padding: 6px 8px;
      border-radius: 4px;
      box-sizing: border-box; /* Important for consistent sizing */
    }
    .add-item-form select {
      /* Ensures the select dropdown in the form has a minimum width */
      min-width: 150px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px #4f46e5;
    }
    .filter-container select {
      background-color: #374151;
      border: 1px solid #4b5563;
      color: #f9fafb;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.875rem;
    }
    #searchInput {
      width: 100%;
      max-width: 500px;
      padding: 10px 15px;
      font-size: 1rem;
      background-color: #374151;
      border: 1px solid #4b5563;
      color: #f9fafb;
      border-radius: 6px;
    }
    #searchInput:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px #4f46e5;
    }
    #searchInput::placeholder { color: #9ca3af; }
    #sheet tr th:first-child,
    #sheet tr td:first-child {
      width: 250px;
    }
    #add-item-container {
      background-color: #111827; /* Very dark, like the table header */
      border: 1px solid #4f46e5; /* Primary color border */
      box-shadow: 0 0 15px rgba(79, 70, 229, 0.2); /* Subtle glow */
      padding: 24px;
      border-radius: 12px;
      margin: 0 auto 24px auto; /* Center with indentation */
      max-width: 95%;
    }
    .add-item-form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px 15px; /* row-gap column-gap */
      align-items: flex-end;
      justify-content: center;
    }
    .add-item-form .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .add-item-form label {
      font-size: 0.75rem;
      color: #9ca3af;
      text-transform: uppercase;
      font-weight: 600;
    }
    .add-item-form button {
      background-color: #4f46e5;
      border-color: #4f46e5;
    }
    .add-item-form button:hover:not(:disabled) {
      background-color: #4338ca;
    }
    .add-item-form button:disabled {
      opacity: 0.7;
    }
    .add-item-form .wide-add-input {
      width: 250px;
    }
    th.short-column,
    td.short-column {
      width: 70px;
    }
    th.count-column,
    td.count-column {
      width: 50px;
      text-align: center;
    }
    .action-column {
      width: 1%;
      white-space: nowrap;
      text-align: center;
    }
    .delete-btn {
      background-color: #ef4444; /* A bright red */
      border: none;
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .delete-btn:hover {
      background-color: #dc2626; /* red-600 */
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #374151;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
    }
    .modal-content h3 {
      margin-top: 0;
      color: #f9fafb;
    }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .modal-buttons button.danger {
      background-color: #dc2626; /* A strong red */
      border-color: #dc2626;
    }
  </style>
</head>

<body>
  <header class="page-header">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/liquid-coop/equipment-checkout/main/Horizontal-Mono-Light.png" alt="Company Logo"
           onerror="this.style.display='none'">
    </div>
    <h1 class="page-title">Equipment Inventory</h1>
    <div class="header-spacer"></div>
  </header>

  <!-- Main app -->
  <div id="app">
    <div class="button-container">
      <button id="signin">Sign in</button>
      <button id="signout" style="display:none">Sign out</button>
      <button id="refresh" style="display:none" onclick="loadData()">Refresh</button>
      <button id="save" style="display:none" onclick="saveData()">Save changes</button>
    </div>
    <div id="add-item-container" style="display:none;"></div>
    <div class="search-container">
      <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search by any column...">
    </div>
    <div id="filter-container" class="filter-container"></div>
    <div id="table-info"></div>
    <div class="table-wrapper">
      <table id="sheet"></table>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete this item? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button id="cancel-delete">Cancel</button>
        <button id="confirm-delete" class="danger">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const CONFIG = {
      CLIENT_ID: '222790090853-hhcir6632un723qjqs1fn2ulcvrj0u02.apps.googleusercontent.com',
      SCOPES: 'https://www.googleapis.com/auth/spreadsheets',
      SPREADSHEET_ID: '1OoZGw6f5qtm--Srnxy41Db-yKrbprWL_PjGxW7PT1z4',
      RANGE: 'LA',
      TOKEN_KEY: 'gapi_token'
    };

    const CONSTANTS = {
      PREDEFINED_STATUSES: ['Good', 'Usable', 'Needs Repair', 'Out for Repair', 'Missing']
    };

    let tokenClient;
    let accessToken;
    let totalItemCount = 0;
    let rowToDelete = null;
    let sheetId = null; // To cache the sheet ID for delete operations
    let sortState = {
      columnIndex: null,
      direction: 'asc' // 'asc' or 'desc'
    };
    let originalHeaders = [];

    // ---- LOAD GAPI & INIT ----
    // The gapi.load callback is the guaranteed entry point after the base GAPI script has loaded.
    gapi.load('client', initializeGapiClient);

    // This function is called once the GAPI client is loaded.
    async function initializeGapiClient() {
      // 1. Load the Google Sheets API client.
      await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');

      // 2. Initialize the OAuth 2.0 token client.
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.CLIENT_ID,
        scope: CONFIG.SCOPES,
        callback: (resp) => {
          if (resp.error) {
            // This can happen on a silent sign-in failure. The user will need to click the "Sign in" button.
            console.warn('Token request failed, user may need to sign in manually.', resp);
            return;
          }
          accessToken = resp.access_token;
          // Use a default of 1 hour (3600 seconds) if expires_in is not provided.
          const expiresAt = Date.now() + (resp.expires_in || 3600) * 1000;
          localStorage.setItem(CONFIG.TOKEN_KEY, JSON.stringify({ access_token: accessToken, expires_at: expiresAt }));
          showApp();
          loadData();
        },
      });

      // 3. Check for a valid, non-expired token in local storage.
      const stored = JSON.parse(localStorage.getItem(CONFIG.TOKEN_KEY) || 'null');
      if (stored && stored.expires_at > Date.now()) {
        accessToken = stored.access_token;
        showApp();
        loadData();
      } else {
        // 4. If no valid token, attempt a silent sign-in. The callback above will handle the response.
        tokenClient.requestAccessToken({ prompt: 'none' });
      }

      // 5. Set up button click handlers.
      document.getElementById('signin').onclick = () => tokenClient.requestAccessToken();
      document.getElementById('signout').onclick = () => {
        accessToken = null;
        localStorage.removeItem(CONFIG.TOKEN_KEY);
        hideApp();
      };
      // Add modal listeners
      document.getElementById('cancel-delete').onclick = () => {
        document.getElementById('delete-modal').style.display = 'none';
        rowToDelete = null;
      };
      document.getElementById('confirm-delete').onclick = () => {
        document.getElementById('delete-modal').style.display = 'none';
        if (rowToDelete !== null) {
          deleteRow(rowToDelete);
        }
      };

      // Add listener for table changes to enable save button
      const sheetTable = document.getElementById('sheet');
      const handleTableChange = () => {
        const saveButton = document.getElementById('save');
        if (saveButton.disabled) {
          saveButton.disabled = false;
          saveButton.textContent = 'Save Changes*';
          saveButton.classList.add('unsaved');
        }
      };
      sheetTable.addEventListener('input', handleTableChange);
    }

    function showApp() {
      document.getElementById('signin').style.display = 'none';
      document.getElementById('signout').style.display = 'inline';
      document.getElementById('refresh').style.display = 'inline';
      const saveButton = document.getElementById('save');
      saveButton.style.display = 'inline';
      saveButton.disabled = true;
      document.getElementById('add-item-container').style.display = 'block';
    }

    function hideApp() {
      document.getElementById('signin').style.display = 'inline';
      document.getElementById('signout').style.display = 'none';
      document.getElementById('refresh').style.display = 'none';
      document.getElementById('save').style.display = 'none';
      document.getElementById('sheet').innerHTML = '';
      document.getElementById('table-info').innerHTML = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('filter-container').innerHTML = '';
      document.getElementById('add-item-container').style.display = 'none';
      document.getElementById('add-item-container').innerHTML = '';
    }

    function getHeaderDisplayText(originalHeader) {
        const headerMap = {
            'Location': 'Loc',
            'Quantity': '#'
        };
        return headerMap[originalHeader] || originalHeader;
    }

    // ---- FETCH DATA ----
    async function loadData() {
      if (!accessToken) return;

      const saveButton = document.getElementById('save');
      saveButton.disabled = true;
      saveButton.textContent = 'Save Changes';
      saveButton.classList.remove('unsaved');

      gapi.client.setToken({ access_token: accessToken });

      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: CONFIG.SPREADSHEET_ID,
        range: CONFIG.RANGE,
      });
      const values = res.result.values || [];

      const tableInfo = document.getElementById('table-info');
      const table = document.getElementById('sheet');
      table.innerHTML = ''; // Clear previous content
      tableInfo.innerHTML = ''; // Clear previous info

      // If there are headers, create the add item form
      if (values.length > 0) {
        originalHeaders = values[0];
        createAddItemForm(values);
      }

      // Create the filter dropdowns before rendering the table
      createFilterDropdowns(values);

      // Display item count. The first row is the header.
      totalItemCount = values.length > 0 ? values.length - 1 : 0;
      if (totalItemCount >= 0) {
        tableInfo.textContent = `${totalItemCount} item${totalItemCount !== 1 ? 's' : ''} in the equipment inventory.`;
      }

      // If there's only a header or no data, stop here.
      if (values.length <= 1) return;

      // Find category column index and unique values for dropdowns
      const headers = values[0];
      const categoryIndex = headers.findIndex(h => h.toLowerCase() === 'category');
      let uniqueCategories = [];
      if (categoryIndex !== -1) {
          uniqueCategories = [...new Set(values.slice(1).map(row => row[categoryIndex]).filter(Boolean))].sort();
      }


      // Create thead and tbody
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      table.appendChild(thead);
      table.appendChild(tbody);

      // Header Row (first row of data)
      const headerRow = document.createElement('tr');
      originalHeaders.forEach((headerText, index) => {
        const th = document.createElement('th');
        th.textContent = getHeaderDisplayText(headerText);
        th.dataset.sortable = "true";
        th.dataset.columnIndex = index;
        th.onclick = () => sortTable(index);

        const lowerCaseHeader = headerText.toLowerCase();
        if (lowerCaseHeader === 'location') {
            th.classList.add('short-column');
        }
        if (lowerCaseHeader === 'quantity') {
            th.classList.add('count-column');
        }
        headerRow.appendChild(th);
      });
      const actionTh = document.createElement('th');
      actionTh.textContent = '';
      actionTh.classList.add('action-column');
      headerRow.appendChild(actionTh);
      thead.appendChild(headerRow);

      // Data Rows (rest of the data)
      values.slice(1).forEach((row, index) => {
        const tr = document.createElement('tr');
        // Iterate over headers to ensure a cell is created for every column, even if empty.
        originalHeaders.forEach((header, headerIndex) => {
          const cellValue = row[headerIndex] || ''; // Use empty string for missing cells
          const td = document.createElement('td');

          const lowerCaseHeader = header.toLowerCase();
          if (lowerCaseHeader === 'location') {
              td.classList.add('short-column');
          }
          if (lowerCaseHeader === 'quantity') {
              td.classList.add('count-column');
          }

          if (header.toLowerCase() === 'category') {
            const select = document.createElement('select');

            // Create a combined list of options to avoid duplicates and ensure the current value is present
            const options = [...uniqueCategories];
            if (cellValue && !options.includes(cellValue)) {
                options.push(cellValue);
                options.sort();
            }

            options.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });

            select.value = cellValue;
            td.appendChild(select);
          } else if (header.toLowerCase() === 'status') {
            const select = document.createElement('select');
            CONSTANTS.PREDEFINED_STATUSES.forEach(stat => {
              const option = document.createElement('option');
              option.value = stat;
              option.textContent = stat;
              select.appendChild(option);
            });
            select.value = cellValue;
            td.appendChild(select);
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = cellValue;
            td.appendChild(input);
          }
          tr.appendChild(td);
        });

        // Add delete button cell
        const actionTd = document.createElement('td');
        actionTd.classList.add('action-column');
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'X';
        deleteButton.className = 'delete-btn';
        // The sheet row index is `index + 2` (1 for header, 1 for 0-based index)
        deleteButton.onclick = () => promptDelete(index + 2);
        actionTd.appendChild(deleteButton);
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
      });

      updateSortIndicators(); // Apply indicators if table was previously sorted
    }

    // ---- ADD ITEM ----
    async function addItem() {
      const addButton = document.querySelector('.add-item-form button');
      const fields = document.querySelectorAll('.add-item-form input[type="text"], .add-item-form select');
      const newRow = Array.from(fields).map(field => field.value);

      if (newRow.every(cell => cell.trim() === '')) {
        alert('Please fill in at least one field to add an item.');
        return;
      }

      addButton.disabled = true;
      addButton.textContent = 'Adding...';

      try {
        gapi.client.setToken({ access_token: accessToken });
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: CONFIG.RANGE,
          valueInputOption: 'USER_ENTERED',
          insertDataOption: 'INSERT_ROWS',
          resource: {
            values: [newRow],
          },
        });
        alert('Item added successfully!');
        loadData(); // Refresh the entire view
      } catch (err) {
        console.error('Error adding item:', err);
        alert('Failed to add item. See console for details.');
        addButton.disabled = false;
        addButton.textContent = 'Add Item';
      }
    }

    function createAddItemForm(values) {
      const container = document.getElementById('add-item-container');
      container.innerHTML = ''; // Clear previous form

      if (values.length === 0) return;
      const headers = values[0];
      const dataRows = values.slice(1);

      const categoryIndex = headers.findIndex(h => h.toLowerCase() === 'category');
      let uniqueCategories = [];
      if (categoryIndex !== -1) {
          uniqueCategories = [...new Set(dataRows.map(row => row[categoryIndex]).filter(Boolean))].sort();
      }


      const headerElement = document.createElement('h3');
      headerElement.textContent = 'Add Item';
      headerElement.style.color = '#f9fafb';
      headerElement.style.fontWeight = '600';
      headerElement.style.fontSize = '1.25rem';
      headerElement.style.marginBottom = '16px';
      headerElement.style.marginTop = '0';
      container.appendChild(headerElement);

      const form = document.createElement('div');
      form.className = 'add-item-form';

      headers.forEach(header => {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        const label = document.createElement('label');
        label.textContent = header;
        inputGroup.appendChild(label);

        if (header.toLowerCase() === 'category') {
          const select = document.createElement('select');
          
          const placeholder = document.createElement('option');
          placeholder.value = "";
          placeholder.textContent = "Choose Category";
          placeholder.disabled = true;
          placeholder.selected = true;
          select.appendChild(placeholder);

          uniqueCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
          inputGroup.appendChild(select);
        } else if (header.toLowerCase() === 'status') {
          const select = document.createElement('select');

          const placeholder = document.createElement('option');
          placeholder.value = "";
          placeholder.textContent = "Choose Status";
          placeholder.disabled = true;
          placeholder.selected = true;
          select.appendChild(placeholder);

          CONSTANTS.PREDEFINED_STATUSES.forEach(stat => {
            const option = document.createElement('option');
            option.value = stat;
            option.textContent = stat;
            select.appendChild(option);
          });
          inputGroup.appendChild(select);
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = `Enter ${header}...`;

          const lowerCaseHeader = header.toLowerCase();
          if (['item', 'description', 'notes'].includes(lowerCaseHeader)) {
            input.classList.add('wide-add-input');
          }

          inputGroup.appendChild(input);
        }
        form.appendChild(inputGroup);
      });

      const addButton = document.createElement('button');
      addButton.textContent = 'Add Item';
      addButton.onclick = addItem;
      form.appendChild(addButton);

      container.appendChild(form);
    }

    // ---- DELETE ITEM ----
    function promptDelete(rowIndex) {
      rowToDelete = rowIndex;
      document.getElementById('delete-modal').style.display = 'flex';
    }

    async function getSheetId(sheetName) {
      if (sheetId) return sheetId; // Return from cache if we have it

      try {
        gapi.client.setToken({ access_token: accessToken });
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
        });

        const sheet = response.result.sheets.find(s => s.properties.title === sheetName);
        if (sheet) {
          sheetId = sheet.properties.sheetId;
          return sheetId;
        } else {
          throw new Error(`Sheet with name "${sheetName}" not found.`);
        }
      } catch (err) {
        console.error('Error fetching sheet metadata:', err);
        throw err; // Re-throw the error to be caught by the caller
      }
    }

    async function deleteRow(rowIndex) {
      if (!accessToken) return;

      const confirmBtn = document.getElementById('confirm-delete');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Deleting...';

      try {
        const currentSheetId = await getSheetId(CONFIG.RANGE); // e.g. 'LA'

        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          resource: {
            requests: [{
              deleteDimension: {
                range: {
                  sheetId: currentSheetId,
                  dimension: 'ROWS',
                  // API is 0-based, sheet rows are 1-based.
                  // The provided rowIndex is 1-based. So we need rowIndex - 1.
                  startIndex: rowIndex - 1,
                  endIndex: rowIndex
                }
              }
            }]
          }
        });
        alert('Item deleted successfully!');
        loadData(); // Refresh the view
      } catch (err) {
        console.error('Error deleting row:', err);
        alert('Failed to delete item. See console for details.');
      } finally {
        rowToDelete = null;
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Delete';
      }
    }

    // ---- SORTING ----
    function sortTable(columnIndex) {
      const table = document.getElementById('sheet');
      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      // Determine sort direction
      let direction = 'asc';
      if (sortState.columnIndex === columnIndex && sortState.direction === 'asc') {
        direction = 'desc';
      }

      sortState.columnIndex = columnIndex;
      sortState.direction = direction;

      const rows = Array.from(tbody.rows);

      rows.sort((a, b) => {
        const aText = a.cells[columnIndex]?.querySelector('input')?.value || '';
        const bText = b.cells[columnIndex]?.querySelector('input')?.value || '';

        // Basic numeric check
        const aIsNum = !isNaN(parseFloat(aText)) && isFinite(aText);
        const bIsNum = !isNaN(parseFloat(bText)) && isFinite(bText);

        let comparison = 0;
        if (aIsNum && bIsNum) {
          comparison = parseFloat(aText) - parseFloat(bText);
        } else {
          comparison = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
        }

        return direction === 'asc' ? comparison : -comparison;
      });

      // Re-append sorted rows
      rows.forEach(row => tbody.appendChild(row));

      // Update header visuals
      updateSortIndicators();
    }

    function updateSortIndicators() {
      const table = document.getElementById('sheet');
      const thead = table.querySelector('thead');
      if (!thead) return;

      const headers = thead.querySelectorAll('th[data-sortable="true"]');
      headers.forEach((th) => {
        const columnIndex = parseInt(th.dataset.columnIndex, 10);
        th.textContent = getHeaderDisplayText(originalHeaders[columnIndex]); // Reset to original text

        if (columnIndex === sortState.columnIndex) {
          const indicator = sortState.direction === 'asc' ? ' ▲' : ' ▼';
          th.textContent += indicator;
        }
      });
    }

    // ---- SAVE DATA ----
    async function saveData() {
      const table = document.getElementById('sheet');
      const saveButton = document.getElementById('save');
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';
      saveButton.classList.remove('unsaved');

      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      if (!thead || !tbody) {
        alert('No data to save.');
        return;
      }

      // Get header data from thead
      const headerRow = originalHeaders;

      // Get body data from tbody inputs
      const bodyRows = Array.from(tbody.rows).map(tr =>
        Array.from(tr.cells).slice(0, -1).map(td => td.querySelector('input, select').value)
      );

      const allRows = [headerRow, ...bodyRows];

      // Note: This will overwrite the entire sheet specified by RANGE.
      try {
        gapi.client.setToken({ access_token: accessToken });
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: CONFIG.SPREADSHEET_ID,
          range: CONFIG.RANGE,
          valueInputOption: 'USER_ENTERED',
          resource: { values: allRows },
        });
        alert('Saved');
        saveButton.textContent = 'Save Changes';
        // The button remains disabled until a new change is made.
      } catch (err) {
        console.error('Error saving data:', err);
        alert('Failed to save data. See console for details.');
        saveButton.disabled = false;
        saveButton.textContent = 'Save Changes*';
        saveButton.classList.add('unsaved');
      }
    }

    // ---- FILTERING LOGIC ----
    function createFilterDropdowns(values) {
      const container = document.getElementById('filter-container');
      container.innerHTML = ''; // Clear existing filters

      if (values.length < 2) return; // No data or only headers

      const headers = values[0];
      const dataRows = values.slice(1);

      const headersToExclude = ['item', 'quantity', 'serial number', 'description'];

      headers.forEach((header, index) => {
        // Don't create filters for columns where a dropdown is not useful (e.g., unique values).
        if (headersToExclude.includes(header.toLowerCase())) {
          return;
        }

        // Get unique, non-empty values for the column and sort them
        const uniqueValues = [...new Set(dataRows.map(row => row[index]).filter(Boolean))].sort();

        // Don't create a filter if there are no unique options to choose from
        if (uniqueValues.length < 1) return;

        const select = document.createElement('select');
        select.dataset.columnIndex = index;
        select.onchange = applyFilters;

        // Add a default "All" option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = `All ${header}`;
        select.appendChild(defaultOption);

        // Add an option for each unique value
        uniqueValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });

        container.appendChild(select);
      });
    }

    function applyFilters() {
      const searchInput = document.getElementById('searchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const table = document.getElementById('sheet');
      const tbody = table.querySelector('tbody');
      const tableInfo = document.getElementById('table-info');
      const filterSelects = document.querySelectorAll('#filter-container select');

      if (!tbody) return;

      const activeFilters = {};
      filterSelects.forEach(select => {
        if (select.value) {
          activeFilters[select.dataset.columnIndex] = select.value;
        }
      });

      const rows = tbody.getElementsByTagName('tr');
      let visibleRowCount = 0;

      for (const row of rows) {
        const inputs = row.querySelectorAll('input[type="text"]');
        let matchesFilters = true;
        for (const columnIndex in activeFilters) {
          if (inputs[columnIndex]?.value !== activeFilters[columnIndex]) {
            matchesFilters = false;
            break;
          }
        }

        const rowText = Array.from(inputs).map(i => i.value).join(' ').toLowerCase();
        const matchesSearch = !searchTerm || rowText.includes(searchTerm);

        const isVisible = matchesFilters && matchesSearch;
        row.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleRowCount++;
      }

      if (searchTerm || Object.keys(activeFilters).length > 0) {
        tableInfo.textContent = `Found ${visibleRowCount} matching item${visibleRowCount !== 1 ? 's' : ''}.`;
      } else {
        tableInfo.textContent = `${totalItemCount} item${totalItemCount !== 1 ? 's' : ''} in the equipment inventory.`;
      }
    }
  </script>
</body>
</html>
