<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Viewer/Editor</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #1f2937; /* A dark blue-gray */
      color: #d1d5db; /* A light gray for text */
    }
    #table-info {
      font-weight: 500;
      text-align: center;
      margin-bottom: 20px;
    }
    .button-container {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 12px;
    }
    button {
      background-color: #4b5563; /* A mid-gray */
      color: #f9fafb; /* Off-white */
      border: 1px solid #6b7280;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #6b7280;
    }
    button#signin {
      background-color: #4f46e5; /* A nice blue for primary action */
      border-color: #4f46e5;
    }
    button#signin:hover {
      background-color: #4338ca;
    }
    table {
      width: auto;
      border-collapse: collapse;
      margin: 0 auto;
      background-color: #374151; /* Darker gray for table bg */
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      border-radius: 8px;
      overflow: hidden; /* To make border-radius work on table */
    }
    td, th { border: 1px solid #4b5563; padding: 8px 12px; }
    thead th {
      background-color: #111827; /* Even darker for header */
      color: #e5e7eb;
      font-weight: 600;
      text-align: left;
    }
    input[type="text"] {
      width: 100px;
      background-color: #4b5563;
      border: 1px solid #6b7280;
      color: #f9fafb;
      padding: 6px 8px;
      border-radius: 4px;
      box-sizing: border-box; /* Important for consistent sizing */
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px #4f46e5;
    }
    #sheet tr td:first-child input[type="text"] {
      width: 250px;
    }
  </style>
</head>

<body>
  <!-- Main app -->
  <div id="app">
    <div class="button-container">
      <button id="signin">Sign in</button>
      <button id="signout" style="display:none">Sign out</button>
      <button id="refresh" style="display:none" onclick="loadData()">Refresh</button>
      <button id="save" style="display:none" onclick="saveData()">Save changes</button>
    </div>
    <div id="table-info"></div>
    <table id="sheet"></table>
  </div>

  <script>
    // ---- CONFIG ----
    const CLIENT_ID = '222790090853-hhcir6632un723qjqs1fn2ulcvrj0u02.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const SPREADSHEET_ID = '1OoZGw6f5qtm--Srnxy41Db-yKrbprWL_PjGxW7PT1z4';
    const RANGE = 'LA';
    const TOKEN_KEY = 'gapi_token';

    let tokenClient;
    let accessToken;

    // ---- LOAD GAPI & INIT ----
    // The gapi.load callback is the guaranteed entry point after the base GAPI script has loaded.
    gapi.load('client', initializeGapiClient);

    // This function is called once the GAPI client is loaded.
    async function initializeGapiClient() {
      // 1. Load the Google Sheets API client.
      await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');

      // 2. Initialize the OAuth 2.0 token client.
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error) {
            // This can happen on a silent sign-in failure. The user will need to click the "Sign in" button.
            console.warn('Token request failed, user may need to sign in manually.', resp);
            return;
          }
          accessToken = resp.access_token;
          // Use a default of 1 hour (3600 seconds) if expires_in is not provided.
          const expiresAt = Date.now() + (resp.expires_in || 3600) * 1000;
          localStorage.setItem(TOKEN_KEY, JSON.stringify({ access_token: accessToken, expires_at: expiresAt }));
          showApp();
          loadData();
        },
      });

      // 3. Check for a valid, non-expired token in local storage.
      const stored = JSON.parse(localStorage.getItem(TOKEN_KEY) || 'null');
      if (stored && stored.expires_at > Date.now()) {
        accessToken = stored.access_token;
        showApp();
        loadData();
      } else {
        // 4. If no valid token, attempt a silent sign-in. The callback above will handle the response.
        tokenClient.requestAccessToken({ prompt: 'none' });
      }

      // 5. Set up button click handlers.
      document.getElementById('signin').onclick = () => tokenClient.requestAccessToken();
      document.getElementById('signout').onclick = () => {
        accessToken = null;
        localStorage.removeItem(TOKEN_KEY);
        hideApp();
      };
    }

    function showApp() {
      document.getElementById('signin').style.display = 'none';
      document.getElementById('signout').style.display = 'inline';
      document.getElementById('refresh').style.display = 'inline';
      document.getElementById('save').style.display = 'inline';
    }

    function hideApp() {
      document.getElementById('signin').style.display = 'inline';
      document.getElementById('signout').style.display = 'none';
      document.getElementById('refresh').style.display = 'none';
      document.getElementById('save').style.display = 'none';
      document.getElementById('sheet').innerHTML = '';
      document.getElementById('table-info').innerHTML = '';
    }

    // ---- FETCH DATA ----
    async function loadData() {
      if (!accessToken) return;
      gapi.client.setToken({ access_token: accessToken });

      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
      });
      const values = res.result.values || [];

      const tableInfo = document.getElementById('table-info');
      const table = document.getElementById('sheet');
      table.innerHTML = ''; // Clear previous content
      tableInfo.innerHTML = ''; // Clear previous info

      // Display item count. The first row is the header.
      const itemCount = values.length > 0 ? values.length - 1 : 0;
      if (itemCount >= 0) {
        tableInfo.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''} in the equipment inventory.`;
      }

      // If there's only a header or no data, stop here.
      if (values.length <= 1) return;

      // Create thead and tbody
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      table.appendChild(thead);
      table.appendChild(tbody);

      // Header Row (first row of data)
      const headerRow = document.createElement('tr');
      values[0].forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Data Rows (rest of the data)
      values.slice(1).forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = cell;
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // ---- SAVE DATA ----
    async function saveData() {
      const table = document.getElementById('sheet');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      // Get header data from thead
      const headerRow = Array.from(thead.rows[0].cells).map(th => th.textContent);

      // Get body data from tbody inputs
      const bodyRows = Array.from(tbody.rows).map(tr =>
        Array.from(tr.cells).map(td => td.querySelector('input').value)
      );

      const allRows = [headerRow, ...bodyRows];

      gapi.client.setToken({ access_token: accessToken });
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values: allRows },
      });
      alert('Saved');
    }
  </script>
</body>
</html>
